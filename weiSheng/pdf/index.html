<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://code.jquery.com/jquery-3.0.0.min.js"></script>
    <script src="http://res.wx.qq.com/open/js/jweixin-1.6.0.js"></script>
    <meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=0">
    <title>证书查询</title>
    <script src="./global/html2canvas.js"></script>
    <script src="./global/jspdf.js"></script>
    <script src="./global/jquery.min.js"></script>
    <link rel="stylesheet" type="text/css" href="./global/index.css" />
</head>
<body>
    <main class="Mobile">
        <header></header>
       <div class="box">
            <div class="box-none">
               <div class="box-none-img"> 
                    <img src="./image/time.png" alt="">
                </div>
                <span>证书查询4月21日开放，敬请等待</span>

            </div>
            <div class="box-block">
                <div class="input">
                    <div class="input-img">
                        <img src="./image/name.png" alt="">
                    </div>
                    <div class="input-name">
                        <input class="name" name="data-name" placeholder="请输入姓名" />
                    </div>
                </div>
                <div class="input">
                    
                    <div class="input-img">
                        <img src="./image/idcard.png" alt="">
                    </div>
                    <div class="input-name" style="width:75%">
                        <input class="id-card" name="data-card" style="width:100%" placeholder="请输入身份证号"/>
                        <div class="close"  onclick="deletes()">
                            <img src="./image/close.png" alt="">
                        </div>
                    </div>        
                </div>
                <div class="warning">
                    <div class="warning-box">
                        <div class="warning-item">
                            <img src="./image/war.png" alt="">
                        </div>
                        <div class="warning-item">
                            <span class="span-text"></span>
                        </div> 
                    </div> 
                </div>
                <div class="button-btn">
                    <button onclick="search(true)">查询</button>
                </div>
                <div class="search-warn">
                    <div class="search-box">
                        <div class="search-item">
                            <img src="./image/war.png" alt="">
                        </div>
                        <div class="search-item">
                            <span class="span-war"></span>
                        </div>
                    </div>
                    
                </div>
                <div class="warn-title">
                    <span>请确认</span>
                    <span class="title-tips">"湖北省新冠肺炎疫情防控大培训"</span>
                    <span>线上考试成绩是 否合格。</span>
                </div>
                <div class="warn-title1">
                    <span>可在</span>
                    <span class="title-tips">"湖北省新冠肺炎疫情防控大培训"</span>
                    <span>平台中的</span>
                    <span class="title-tips">"个人信息"</span>
                    <span>查看</span>
                </div>
            </div>
            <footer>4月21日后，“疫情防控知识大培训”线上培训考核合格的学员可申领培训合格证书。</footer>
       </div>
       <div class="right-asides">
            <div class="canvas_box" >
                <canvas id="canvas" style="background:#fff;width:100%;height:100%"></canvas>
            </div>
            <div class="canvas-btn">
                <button class="download" id="savePdf"  onclick="generateCanvas()">保存证书</button>
            </div>
        </div>


    </main>

    <main class="Desktop">
        <header></header>
       <div class="box">
            <div class="box-none">
               <div class="box-none-img"> 
                    <img src="./image/time.png" alt="">
                </div>
                <span>证书查询4月21日开放，敬请等待</span>
            </div>
            <div class="box-block">
                <div class="input">
                    <div class="input-img">
                        <img class="img-name"   src="./image/name.png" alt="">
                    </div>
                    <div class="input-name">
                        <input class="name" name="data-nickName" placeholder="请输入姓名" /> 
                    </div>
                </div>
                <div class="input">
                    <div class="input-img" >
                        <img  class="input-img1" src="./image/idcard.png" alt="">
                    </div>
                    <div class="input-name">
                        <input class="id-card"  name="data-idCard" placeholder="请输入身份证号"/>
                        <div class="close"  onclick="deletes()">
                            <img src="./image/close.png" alt="">
                        </div>
                    </div>
                </div>
                <div class="warning">
                    <div class="warning-box">
                        <div class="warning-item">
                            <img src="./image/war.png" alt="">
                        </div>
                        <div class="warning-item">
                            <span class="span-text"></span>
                        </div> 
                    </div> 
                </div>
                <div class="button-btn">
                    <button onclick="search(false)">查询</button>
                </div>
                <div class="search-warn">
                        <div class="search-box">
                            <div class="search-item">
                                <img src="./image/war.png" alt="">
                            </div>
                            <div class="search-item">
                                <span class="span-war"></span>
                            </div>
                        </div>
                </div>
                <div class="warn-title">
                    <span>请确认</span>
                    <span class="title-tips">"湖北省新冠肺炎疫情防控大培训"</span>
                    <span>线上考试成绩是 否合格。</span>
                </div>
                <div class="warn-title1">
                    <span>可在</span>
                    <span class="title-tips">"湖北省新冠肺炎疫情防控大培训"</span>
                    <span>平台中的</span>
                    <span>"个人信息"</span>
                    <span>查看</span>
                </div>
            </div>
            <footer>4月21日后，“疫情防控知识大培训”线上培训考核合格的学员可申领培训合格证书。</footer>
       </div>
       <div class="right-asides">
        <div class="canvas_box" >
            <canvas id="canvas1" width="498" height="682"></canvas>
        </div>
        <div class="canvas-btn">
            <button class="download" id="savePdf"  onclick="generateCanvas()" >保存证书</button>

        </div>
    </div>
    </main>
</body>
</html>
<script>
    // function downloaded(){
    //     var ua = navigator.userAgent.toLowerCase();
    //     if(ua.match(/MicroMessenger/i)=="micromessenger") {
    //         alert("请点击右上角，选择浏览器中打开");
    //         $("main").css('display','none')
    //     } else {
           
    //     }
    // }
    // downloaded()
    var canvasShow = '';
    var name = '';
    var idCard = '';
    var date = '';





     (function() {
        var machineType = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ? 'Mobile' : 'Desktop'
        if (machineType === 'Mobile')    {
            $(".Desktop").css('display', 'none')
            $(".right-asides").css("display",'none')
            var designW = 750; //设计稿宽
            var font_rate = 100;
            //适配
            document.getElementsByTagName("html")[0].style.fontSize = document.body.offsetWidth / designW * font_rate + "px";
            document.getElementsByTagName("body")[0].style.fontSize = document.body.offsetWidth / designW * font_rate + "px";
            //监测窗口大小变化
            window.addEventListener("onorientationchange" in window ? "orientationchange" : "resize", function() {
            document.getElementsByTagName("html")[0].style.fontSize = document.body.offsetWidth / designW * font_rate + "px";
            document.getElementsByTagName("body")[0].style.fontSize = document.body.offsetWidth / designW * font_rate + "px";

            }, false);

        } else    {
            $(".Mobile").css('display', 'none')
            $(".right-asides").css("display",'none')
            $("#canvas").css("display",'none')

            }
            $(".box-none").css('display', 'none')
            
    })();
    

    $("input").focus(function(){
        $("footer").css('display', 'none')　
    });
    $("input").blur(function(){
        $("footer").css('display', 'block')　
    });
    //查询

    function deletes() {
        $(".id-card").val("")
    }
    //  creatDarw(true,'你号','420107199303302014')

    function search (state) {
        if(state) {
            name = $("input[name='data-name']").val()
            idCard = $("input[name='data-card']").val()
        } else {
            name = $("input[name='data-nickName']").val()
            idCard = $("input[name='data-idCard']").val()
        }
        let flag = false
        console.log(name)
        console.log(idCard)

        if(!name) {
            $(".span-text").html('请输入姓名')
            $(".search-warn").css("display",'none')
            $(".warning").css("display",'block')
            $(".warn-title").css("display",'none')
            $(".warn-title1").css("display",'none')

            
            flag = false
            return
        }
        if( !idCard) {
            $(".warning").css("display",'block')
            $(".search-warn").css("display",'none')
            $(".span-text").html('请输入身份证号码')
            $(".warn-title").css("display",'none')
            $(".warn-title1").css("display",'none')
            return
        } else {
            if(idCard.length === 18) {
                if(!this.checkIDCard(idCard)) {
                $(".warning").css("display",'block')
                $(".search-warn").css("display",'none')
                $(".span-text").html('身份证号格式错误')
                $(".warn-title").css("display",'none')
                $(".warn-title1").css("display",'none')
                    return
                } else {
                    flag = true
                }
            } else {
                flag = true
            }
            
        }
        if(flag){
            $(".warning").css("display",'none')
            getAjax(name,idCard).then( res =>{
                if (!res.data) {
                     $(".span-war").html("没有查询到证书")
                     $(".warn-title").css("display",'block')
                     $(".search-warn").css("display",'block')  
                } else {
                    $(".right-asides").css("display",'block')
                    $(".box").css('display', 'none')
                    creatDarw(state,name,idCard)
                    date = res.data
                }
            }).catch(req =>{
                $(".warning").css("display",'none')
                $(".search-warn").css("display",'block')
                let war = '不匹配'
                let war1 = '证书'
                let war2 = '没有查询到您的身份证号'
                let index = req.data.value.indexOf(war)
                let index1 = req.data.value.indexOf(war1)
                let index2 = req.data.value.indexOf(war2)
                
                if(index != -1) {
                    $(".span-war").html('姓名和证件号不匹配')
                    $(".warn-title").css("display",'none')
                    $(".warn-title1").css("display",'block')
                } else if (index1 != -1) {
                    $(".span-war").html('没有查询到证书')
                    $(".warn-title").css("display",'block')
                    $(".warn-title1").css("display",'none')
                } else if (index2 != -1)  {
                    $(".span-war").html('没有查询到您的证件号')
                    $(".warn-title").css("display",'none')
                    $(".warn-title1").css("display",'block')
                }  else {
                    $(".warn-title").css("display",'none')
                    $(".warn-title1").css("display",'none')
                    $(".warning").css("display",'block')
                    $(".span-text").html(req.data.value)
                    $(".search-warn").css("display",'none')
                }   
            })
        }
    }

    function getAjax(name,idCard){
        let result = new Promise( ( res,req) =>{
            let  ajax = new XMLHttpRequest();
            ajax.open('get', `https://kspx.hbwsrc.cn:8083/wxApplets/getStudyFinish?name=${name}&idCard=${idCard}`);
            ajax.send()
            ajax.onreadystatechange = function() {
                let data = JSON.parse(ajax.response)
                    if (ajax.readyState == 4 && ajax.status == 200) {
                        if(data.code == 200 ) {
                           res(data)
                        } else if ( data.code == 201 ) {
                            req(data)
                        }
                    }
                }
        })
        return result
    } 
    function checkIDCard(idcode) {
        let weight_factor = [7, 9, 10, 5, 8, 4, 2, 1, 6, 3, 7, 9, 10, 5, 8, 4, 2]
        // 校验码
        let check_code = ['1', '0', 'X', '9', '8', '7', '6', '5', '4', '3', '2']

        let code = idcode + ''
        let last = idcode[17] // 最后一位

        let seventeen = code.substring(0, 17)

        // ISO 7064:1983.MOD 11-2
        // 判断最后一位校验码是否正确
        let arr = seventeen.split('')
        let len = arr.length
        let num = 0
        for (let i = 0; i < len; i++) {
            num = num + arr[i] * weight_factor[i]
        }

        // 获取余数
        let resisue = num % 11
        let last_no = check_code[resisue]

        // 格式的正则
        // 正则思路
        /*
                    第一位不可能是0
                    第二位到第六位可以是0-9
                    第七位到第十位是年份，所以七八位为19或者20
                    十一位和十二位是月份，这两位是01-12之间的数值
                    十三位和十四位是日期，是从01-31之间的数值
                    十五，十六，十七都是数字0-9
                    十八位可能是数字0-9，也可能是X
                    */
        let idcard_patter =
            /^[1-9][0-9]{5}([1][9][0-9]{2}|[2][0][0|1][0-9])([0][1-9]|[1][0|1|2])([0][1-9]|[1|2][0-9]|[3][0|1])[0-9]{3}([0-9]|[X])$/

        // 判断格式是否正确
        let format = idcard_patter.test(idcode)

        // 返回验证结果，校验码和格式同时正确才算是合法的身份证号码
        return last === last_no && format ? true : false;
    }
    function creatDarw(state,name,idCard,w=498,h=682) { //创建画板
        if(state) {
            canvasShow = 'Mobile'
        } else {
            canvasShow = 'Desktop'

        }
        let c1 = ''
        let  winWidth = ''
        let winHeight = ''
        if( canvasShow == 'Desktop') {
         c1 = document.querySelector('#canvas1')
         winWidth = canvas.width;
         winHeight = canvas.height;
         canvasShowImage(c1,name,idCard,winWidth,winHeight)
        } else {
         c1 = document.querySelector('#canvas')
          winWidth = canvas.width;
         winHeight = canvas.height;
         canvasShowImage(c1,name,idCard,winWidth,winHeight)

        }
      
    }


        const PDF = {}
        let a4Width = 595.28; 
        let a4Height = 841.89
        let defaultOptions  =  {
            name: new Date().getTime(),
            scale: window.devicePixelRatio * 2,
            padding: 0,
            width: 595.28 * 2,
            allowTaint: true,
            onclone: function (dom) {
                let screen = dom.querySelector('#canvas1');
                screen.style.width = 595.28 * 2 + 'px';
                screen.style.padding = '10px';
            }
        }
    function canvasShowImage(c1,name,idCard,winWidth,winHeight){
        let ctx = c1.getContext('2d')
        let dpr = window.devicePixelRatio
        let { width: cssWidth, height: cssHeight  } = canvas.getBoundingClientRect()
        canvas.width = dpr * cssWidth;
        canvas.height = dpr * cssHeight;
        const pdfWidth =  cssWidth
        const pdfHieght = cssHeight
        ctx.scale(dpr,dpr);
        const scale = 300*dpr * cssHeight
        var type =['repeat']
        var img = new Image();
        img.src = "./image/certificate1.jpg"
        img.crossOrigin = "anonymous";
        img.onload = function() {
            let imgW = img.width
            let imgH = img.height
            ctx.drawImage(img,0,0,705/2,498/2)
            // ctx.drawImage(this,0,0,winWidth,imgH*winWidth/imgW)

            ctx.font = "10px 仿宋";
            ctx.fillText(idCard,213,100);
            ctx.fillText(name,91, 100)
            ctx.fillText(date,258, 210)
            ctx.fillStyle = ctx.createPattern(img, type[0])
        }
    }

    function generateCanvas() {
        const canvas = document.getElementById("canvas1");
            const ctx = canvas.getContext("2d");
            console.log(canvas)
            // 文件选择
            const image = new Image();
            image.src = './image/certificate1.jpg';
            image.onload = function(event) {
                console.log(image.src);
                URL.revokeObjectURL(this.src);
                canvas.width = image.width;
                canvas.height = image.height;
                ctx.drawImage(image,0, 0)
                ctx.font = "35px 仿宋";
                ctx.fillText(name, 360, 365);
                ctx.fillText(idCard, 790, 365);
                ctx.fillText(date, 940, 770);
            }

            // 保存打印
            let Dom = document.getElementById("savePdf");
            Dom.addEventListener("click", function() {
                var u = navigator.userAgent, app = navigator.appVersion
                let isAndroid = u.indexOf('Android') > -1 || u.indexOf('Adr') > -1;
                //ios终端;
                // let isiOS = !!u.match(/(i[^;]+;( U;)? CPU.+Mac OS X/);
                if (isAndroid) {
                    let ImageData = canvas.toDataURL('image/png');
                    var doc = new jsPDF();
                    doc.addImage(ImageData, 'JPEG', 15, 40, 180, 140);
                    doc.save("证书.pdf");
                } else {
                    var a = document.createElement("a")
                    a.href = canvas.toDataURL()
                    a.download = "证书"
                    a.click()
                    $("a").remove()
                    console.log(a)
                    // return 'ios'
                }

               
            });
    }
        // window.onload =() => {
   
            
        
        // var contentWidth ,contentHeight ,target=""
        // if( canvasShow == 'Desktop') {
        //     canvas = document.querySelector('#canvas1')
        // } else {
        //     canvas = document.querySelector('#canvas')
        // }
        // let scale = window.devicePixelRatio * 2
        // html2canvas(canvas,   { //添加dom元素
        //     // width:  1020,
        //     // height:850,
        //     x:0,
        //     y:0,
        //     dpi: 450,   //将分辨率提高到特定的DPI 
        //     foreignObjectRendering: true,   //如果浏览器支持，是否使用 ForeignObject 渲染
        //     useCORS: true,  //是否尝试使用 CORS 从服务器加载图像
        //     background: "#ffffff",
        //     async: false,  //用于渲染的比例。默认为浏览器设备像素比
        //     onrendered:function(canvas) {
        //         var canvasWidth = canvas.width  / scale
        //         var canvasHeight = canvas.height  / scale
        //         let pageWidth =  595.28
        //         let pageHeight = 592.28 / canvasWidth * canvasHeight;
        //         //一页pdf显示html页面生成的canvas高度;
        //         // var pageHeight =  contentWidth / 592.28 * 841.89;
        //         //页面偏移
        //         var position = 0;
        //         //a4纸的尺寸[595.28,841.89]，html页面生成的canvas在pdf中图片的宽高
        //         var jpeg = canvas.toDataURL('jpg', 1.0);
        //         var pdf = new jsPDF('', 'pt', 'a4');  
        //         //有两个高度需要区分，一个是html页面的实际高度，和生成pdf的页面高度(841.89)
        //         //当内容未超过pdf一页显示的范围，无需分页
        //         if (canvasHeight < pageHeight) {
        //             pdf.addImage(jpeg, 'jpg', 0, 0, pageWidth, pageHeight );
        //         } else {
        //             while(canvasHeight > 0) {
        //                 pdf.addImage(jpeg, 'jpg', 0, position, pageWidth, pageHeight)
        //                 canvasHeight -= pageHeight;
        //                 position -=a4Height;
        //                 //避免添加空白页
        //                 if(canvasHeight > 0) {
        //                     pdf.addPage();
        //                 }
        //             }
        //         }
           
        //         pdf.save("证书.pdf");
        //     }
        // })
    // }

</script>